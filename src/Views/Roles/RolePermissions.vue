<template>
  <ModuleComponent
    title="Roles"
    description="Manage Roles and Permission"
    moduleName="roles"
    moduleNameSingular="role"
    :data="roles"
    :columns="roleColumns"
    :formFields="roleFormFields"
    :fetchData="fetchRoles"
    :addItem="addRole"
    :updateItem="updateRole"
    :deleteItem="deleteRole"
    searchPlaceholder="Search Roles..."
    addButtonText="Add Role"
    :showExportButtons="false"
    :showImportButton="false"
    :getId="getRoleId"
  >
    <!-- âœ… Actions slot - This will show for each row -->
    <template #row-actions="{ item }">
      <button
        @click="openPermissionModal(item)"
        class="p-2 text-green-600 hover:bg-green-100 rounded-full"
        title="Manage Permissions"
      >
        <ShieldCheckIcon class="w-5 h-5" />
      </button>
    </template>
  </ModuleComponent>

  <!-- Permission Modal -->
  <PermissionModal
    :isOpen="showPermissionModal"
    :role="selectedRole"
    :permissions="permissionGroups"
    :modelValue="selectedRolePermissions"
    @close="showPermissionModal = false"
    @save="saveRolePermissions"
  />
</template>

<script>
import { ref, computed, onMounted } from "vue";
import { useToast } from "vue-toastification";
import ModuleComponent from "../../components/ModuleComponent/ModuleComponent.vue";
import PermissionModal from "../../components/Modals/PermissionModal.vue";
import { ShieldCheckIcon } from "@heroicons/vue/24/outline";
import { useRolePermissionsStore } from "../../store/RolePermissionsStore";

export default {
  name: "RolesManagement",
  components: {
    ModuleComponent,
    PermissionModal,
    ShieldCheckIcon
  },
  setup() {
    const toast = useToast();
    const roles = ref([]);
    const showPermissionModal = ref(false);
    const selectedRole = ref(null);
    const selectedRolePermissions = ref([]);
    const permissionGroups = ref([]);

    const roleStore = useRolePermissionsStore();

    // Load roles and permissions
    const fetchRoles = async () => {
      try {
        const response = await roleStore.GetRoles();
        roles.value = response; // expect API to return roles array
      } catch (error) {
        toast.error("Failed to load roles");
        console.error(error);
      }
    };

    const fetchPermissions = async () => {
      try {
        const response = await roleStore.GetPermissions();
        groupPermissions(response);
      } catch (error) {
        toast.error("Failed to load permissions");
        console.error(error);
      }
    };

    // Group permissions by module for PermissionModal
    const groupPermissions = (permissions) => {
      const grouped = permissions.reduce((acc, perm) => {
        if (!acc[perm.module]) acc[perm.module] = [];
        acc[perm.module].push({
          key: perm.permissionName,
          label: perm.description
        });
        return acc;
      }, {});
      permissionGroups.value = Object.keys(grouped).map((module) => ({
        name: module,
        items: grouped[module]
      }));
    };

    const statusOptions = ref([
      { value: true, label: "Active" },
      { value: false, label: "Inactive" }
    ]);

    const roleColumns = [
      { field: "roleName", label: "Role", type: "text", sortable: true },
      { field: "isActive", label: "Status", type: "status", sortable: true },
      { field: "createdBy", label: "Created By", type: "text", sortable: true },
      { field: "createdAt", label: "Created On", type: "date", sortable: true }
    ];

    // Form fields for roles
    const roleFormFields = computed(() => [
      { 
        key: "roleName", 
        label: "Role Name", 
        type: "text", 
        required: true, 
        placeholder: "Enter Role Name" 
      },
      { 
        key: "description", 
        label: "Description", 
        type: "textarea", 
        maxLength: 500, 
        placeholder: "Enter description" 
      },
      { 
        key: "isActive", 
        label: "Status", 
        type: "select", 
        required: true, 
        options: statusOptions.value,
        placeholder: "Select status" 
      }
    ]);

    // Create Role
    const addRole = async (roleData) => {
      try {
        const newRole = await roleStore.AddRole(roleData);
        roles.value.push(newRole);
        toast.success("Role added successfully");
        return newRole;
      } catch (error) {
        toast.error("Failed to add role");
        throw error;
      }
    };

    // Update Role
    const updateRole = async (id, roleData) => {
      try {
        const updatedRole = await roleStore.UpdateRole(id, roleData);
        const index = roles.value.findIndex(role => role.roleId === id);
        if (index !== -1) roles.value[index] = updatedRole;
        toast.success("Role updated successfully");
        return updatedRole;
      } catch (error) {
        toast.error("Failed to update role");
        throw error;
      }
    };

    // Delete Role
    const deleteRole = async (id) => {
      try {
        await roleStore.DeleteRole(id);
        roles.value = roles.value.filter(r => r.roleId !== id);
        toast.success("Role deleted successfully");
      } catch (error) {
        toast.error("Failed to delete role");
        throw error;
      }
    };

    const getRoleId = (role) => role.roleId;

    // Open modal for permissions
    const openPermissionModal = async (role) => {
      selectedRole.value = role;
      try {
        const rolePermissions = await roleStore.GetRolePermissions(role.roleId);
        selectedRolePermissions.value = rolePermissions?.permissions || [];
        showPermissionModal.value = true;
      } catch (error) {
        toast.error("Failed to load role permissions");
        console.error(error);
      }
    };

    // Save permissions
    const saveRolePermissions = async ({ roleId, permissions }) => {
      try {
        await roleStore.UpdateRolePermissions(roleId, permissions);
        toast.success("Permissions updated successfully");
        showPermissionModal.value = false;
      } catch (error) {
        toast.error("Failed to update permissions");
        console.error(error);
      }
    };

    onMounted(() => {
      fetchRoles();
      fetchPermissions();
    });

    return {
      roles,
      roleColumns,
      roleFormFields,
      showPermissionModal,
      selectedRole,
      selectedRolePermissions,
      permissionGroups,
      fetchRoles,
      addRole,
      updateRole,
      deleteRole,
      getRoleId,
      openPermissionModal,
      saveRolePermissions
    };
  }
};
</script>
